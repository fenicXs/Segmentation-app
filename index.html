<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chest X-ray Segmentation</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="card">
    <div>
      <header>
        <h1>Chest X-ray Segmentation</h1>
        <p>Drop a chest X-ray, send it to the n8n webhook, and view the segmented overlay.</p>
      </header>

      <div class="section" style="margin-top:16px;">
        <label for="endpoint">Webhook endpoint (use /webhook for live, /webhook-test when workflow is not activated)</label>
        <input id="endpoint" type="text" value="https://unappealed-oralia-unbeneficed.ngrok-free.dev/webhook/seg-chestxray" />
        <div class="pill">Binary field name: <strong>file</strong></div>
      </div>

      <div class="section" style="margin-top:16px;">
        <div id="dropzone" class="dropzone">
          <strong>Drag & drop</strong> a chest X-ray here or click to browse
          <div class="file-meta" id="file-meta">No file selected</div>
        </div>
        <input id="file-input" type="file" accept="image/*" style="display:none;" />

        <div class="actions">
          <button id="run-btn" disabled>Segment</button>
          <div class="status" id="status">Select an image to begin.</div>
        </div>
      </div>
    </div>

    <div class="section preview">
      <div id="preview-placeholder" style="text-align:center; color:var(--muted); padding:12px;">
        Segmented overlay will appear here.
      </div>
      <img id="preview-img" alt="Segmented overlay" style="display:none;" />
    </div>
  </div>

  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("file-input");
    const fileMeta = document.getElementById("file-meta");
    const runBtn = document.getElementById("run-btn");
    const statusEl = document.getElementById("status");
    const endpointInput = document.getElementById("endpoint");
    const previewImg = document.getElementById("preview-img");
    const previewPlaceholder = document.getElementById("preview-placeholder");

    let selectedFile = null;

    function setStatus(text, tone = "muted") {
      statusEl.textContent = text;
      statusEl.style.color = tone === "error" ? "#f87171" : (tone === "ok" ? "#a7f3d0" : "var(--muted)");
    }

    function humanSize(bytes) {
      if (!bytes) return "0 B";
      const units = ["B", "KB", "MB", "GB"];
      const i = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
      return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${units[i]}`;
    }

    function setFile(file) {
      selectedFile = file;
      if (file) {
        fileMeta.textContent = `${file.name} â€¢ ${humanSize(file.size)}`;
        runBtn.disabled = false;
        setStatus("Ready to send.");
      } else {
        fileMeta.textContent = "No file selected";
        runBtn.disabled = true;
        setStatus("Select an image to begin.");
      }
    }

    dropzone.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        setFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener("change", (e) => {
      if (e.target.files && e.target.files[0]) {
        setFile(e.target.files[0]);
      }
    });

    async function sendToWebhook() {
      if (!selectedFile) return;
      const endpoint = endpointInput.value.trim();
      if (!endpoint) {
        setStatus("Endpoint cannot be empty.", "error");
        return;
      }

      runBtn.disabled = true;
      setStatus("Uploading to n8n...");

      const formData = new FormData();
      formData.append("file", selectedFile, selectedFile.name || "upload.png");

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Request failed (${response.status}): ${text.slice(0, 200)}`);
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);

        previewImg.src = url;
        previewImg.style.display = "block";
        previewPlaceholder.style.display = "none";
        setStatus("Segmentation complete.", "ok");
      } catch (err) {
        console.error(err);
        setStatus(err.message || "Upload failed.", "error");
      } finally {
        runBtn.disabled = false;
      }
    }

    runBtn.addEventListener("click", sendToWebhook);
  </script>
</body>
</html>
